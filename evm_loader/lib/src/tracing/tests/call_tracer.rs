use crate::commands::emulate::EmulateResponse;
use crate::tracing::tests::helpers;
use crate::tracing::tests::helpers::{call_tracer_config, rent_account, test_tracer, TestRpc};
use crate::types::TxParams;
use ethnum::U256;
use evm_loader::types::Address;
use solana_sdk::pubkey::Pubkey;

#[tokio::test]
async fn test_call_tracer_contract_creation() {
    let program_id = Pubkey::new_unique();

    let tx = TxParams {
        from: Address::from_hex("0x82211934C340b29561381392348D48413E15ADC8").unwrap(),
        data: Some(hex::decode("608060405234801561001057600080fd5b50610917806100206000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c806383f9a7d51161007157806383f9a7d514610140578063873d1a021461015c5780638a063ff61461017a578063d09de08a14610184578063dcd9c7fa1461018e578063f315cde1146101aa576100a9565b8063067d5cd5146100ae57806312065fe0146100de5780632e64cec1146100fc5780634bb278f31461011a5780636057361d14610124575b600080fd5b6100c860048036038101906100c391906103db565b6101da565b6040516100d59190610417565b60405180910390f35b6100e66101fe565b6040516100f39190610417565b60405180910390f35b610104610208565b6040516101119190610417565b60405180910390f35b610122610211565b005b61013e600480360381019061013991906103db565b610253565b005b61015a60048036038101906101559190610490565b61025d565b005b61016461028a565b6040516101719190610417565b60405180910390f35b6101826102ad565b005b61018c610332565b005b6101a860048036038101906101a391906103db565b61034d565b005b6101c460048036038101906101bf91906103db565b610387565b6040516101d19190610417565b60405180910390f35b6000816000808282546101ed91906104ec565b925050819055506000549050919050565b6000600154905090565b60008054905090565b60006040518060600160405280602a81526020016108b8602a913961023590610589565b60601c90508073ffffffffffffffffffffffffffffffffffffffff16ff5b8060008190555050565b60018173ffffffffffffffffffffffffffffffffffffffff163161028191906104ec565b60018190555050565b6000600160008082825461029e91906104ec565b92505081905550600054905090565b7f8604f2dc82d77e997bcc9f6b4a10c9175a9be5fb69a9ef44bbb5c4eaa66ca36461148460c86040516102e192919061067d565b60405180910390a17f99986dab9136c96a7db07b9393684e3a152ce628162b6ebbdb6fbdca3ae2d581600a6014601e60286032603c60405161032896959493929190610856565b60405180910390a1565b600160008082825461034491906104ec565b92505081905550565b7f2adf2e2e5f5d116e0d0e1f0231d3f5b75916c3d37d9a16ce060f634cbcc614308160405161037c9190610417565b60405180910390a150565b600060018261039691906104ec565b9150819050919050565b600080fd5b6000819050919050565b6103b8816103a5565b81146103c357600080fd5b50565b6000813590506103d5816103af565b92915050565b6000602082840312156103f1576103f06103a0565b5b60006103ff848285016103c6565b91505092915050565b610411816103a5565b82525050565b600060208201905061042c6000830184610408565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061045d82610432565b9050919050565b61046d81610452565b811461047857600080fd5b50565b60008135905061048a81610464565b92915050565b6000602082840312156104a6576104a56103a0565b5b60006104b48482850161047b565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006104f7826103a5565b9150610502836103a5565b925082820190508082111561051a576105196104bd565b5b92915050565b600081519050919050565b6000819050602082019050919050565b60007fffffffffffffffffffffffffffffffffffffffff00000000000000000000000082169050919050565b6000610573825161053b565b80915050919050565b600082821b905092915050565b600061059482610520565b8261059e8461052b565b90506105a981610567565b925060148210156105e9576105e47fffffffffffffffffffffffffffffffffffffffff0000000000000000000000008360140360080261057c565b831692505b5050919050565b6000819050919050565b6000819050919050565b600061061f61061a610615846105f0565b6105fa565b6103a5565b9050919050565b61062f81610604565b82525050565b6000819050919050565b600060ff82169050919050565b600061066761066261065d84610635565b6105fa565b61063f565b9050919050565b6106778161064c565b82525050565b60006040820190506106926000830185610626565b61069f602083018461066e565b9392505050565b6000819050919050565b60006106cb6106c66106c1846106a6565b6105fa565b61063f565b9050919050565b6106db816106b0565b82525050565b6000819050919050565b600061ffff82169050919050565b600061071461070f61070a846106e1565b6105fa565b6106eb565b9050919050565b610724816106f9565b82525050565b6000819050919050565b600063ffffffff82169050919050565b600061075f61075a6107558461072a565b6105fa565b610734565b9050919050565b61076f81610744565b82525050565b6000819050919050565b600067ffffffffffffffff82169050919050565b60006107ae6107a96107a484610775565b6105fa565b61077f565b9050919050565b6107be81610793565b82525050565b6000819050919050565b60006fffffffffffffffffffffffffffffffff82169050919050565b60006108056108006107fb846107c4565b6105fa565b6107ce565b9050919050565b610815816107ea565b82525050565b6000819050919050565b600061084061083b6108368461081b565b6105fa565b6103a5565b9050919050565b61085081610825565b82525050565b600060c08201905061086b60008301896106d2565b610878602083018861071b565b6108856040830187610766565b61089260608301866107b5565b61089f608083018561080c565b6108ac60a0830184610847565b97965050505050505056fe307838323231313933344333343062323935363133383133393233343844343834313345313541444338a2646970667358221220602cb20f9fda43c380fec5435cb9da37e1a0caa5a27847fb7a31f6660f663c3564736f6c63430008130033").unwrap()),
        value: Some(U256::ZERO),
        gas_limit: Some(U256::from_str_hex("0x1f77910").unwrap()),
        actual_gas_used: Some(U256::from_str_hex("0x1f73e78").unwrap()),
        gas_price: Some(U256::from_str_hex("0x2a6842533a").unwrap()),
        chain_id: Some(0xe9ac0ce),
        ..TxParams::default()
    };

    test_tracer(
        program_id,
        call_tracer_config(),
        tx.clone(),
        TestRpc::new(
            [
                helpers::balance_account(
                    &program_id,
                    tx.from,
                    tx.chain_id.unwrap(),
                    36,
                    U256::from_str_hex("0x8c5db98fa02fd85d8").unwrap(),
                ),
                rent_account(),
            ]
            .into(),
        ),
        EmulateResponse {
            exit_status: "succeed".to_string(),
            external_solana_call: false,
            reverts_before_solana_calls: false,
            reverts_after_solana_calls: false,
            result: tx.data.unwrap().into_iter().skip(32).collect::<Vec<_>>(),
            steps_executed: 17,
            used_gas: 25_000,
            iterations: 3,
            solana_accounts: vec![],
            logs: vec![],
        },
        3,
        "{\"from\":\"0x82211934c340b29561381392348d48413e15adc8\",\"gas\":\"0x1f77910\",\"gasUsed\":\"0x1f73e78\",\"to\":\"0x8a1254358366ae176dfa348dee80dcd5baef1ae8\",\"input\":\"0x608060405234801561001057600080fd5b50610917806100206000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c806383f9a7d51161007157806383f9a7d514610140578063873d1a021461015c5780638a063ff61461017a578063d09de08a14610184578063dcd9c7fa1461018e578063f315cde1146101aa576100a9565b8063067d5cd5146100ae57806312065fe0146100de5780632e64cec1146100fc5780634bb278f31461011a5780636057361d14610124575b600080fd5b6100c860048036038101906100c391906103db565b6101da565b6040516100d59190610417565b60405180910390f35b6100e66101fe565b6040516100f39190610417565b60405180910390f35b610104610208565b6040516101119190610417565b60405180910390f35b610122610211565b005b61013e600480360381019061013991906103db565b610253565b005b61015a60048036038101906101559190610490565b61025d565b005b61016461028a565b6040516101719190610417565b60405180910390f35b6101826102ad565b005b61018c610332565b005b6101a860048036038101906101a391906103db565b61034d565b005b6101c460048036038101906101bf91906103db565b610387565b6040516101d19190610417565b60405180910390f35b6000816000808282546101ed91906104ec565b925050819055506000549050919050565b6000600154905090565b60008054905090565b60006040518060600160405280602a81526020016108b8602a913961023590610589565b60601c90508073ffffffffffffffffffffffffffffffffffffffff16ff5b8060008190555050565b60018173ffffffffffffffffffffffffffffffffffffffff163161028191906104ec565b60018190555050565b6000600160008082825461029e91906104ec565b92505081905550600054905090565b7f8604f2dc82d77e997bcc9f6b4a10c9175a9be5fb69a9ef44bbb5c4eaa66ca36461148460c86040516102e192919061067d565b60405180910390a17f99986dab9136c96a7db07b9393684e3a152ce628162b6ebbdb6fbdca3ae2d581600a6014601e60286032603c60405161032896959493929190610856565b60405180910390a1565b600160008082825461034491906104ec565b92505081905550565b7f2adf2e2e5f5d116e0d0e1f0231d3f5b75916c3d37d9a16ce060f634cbcc614308160405161037c9190610417565b60405180910390a150565b600060018261039691906104ec565b9150819050919050565b600080fd5b6000819050919050565b6103b8816103a5565b81146103c357600080fd5b50565b6000813590506103d5816103af565b92915050565b6000602082840312156103f1576103f06103a0565b5b60006103ff848285016103c6565b91505092915050565b610411816103a5565b82525050565b600060208201905061042c6000830184610408565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061045d82610432565b9050919050565b61046d81610452565b811461047857600080fd5b50565b60008135905061048a81610464565b92915050565b6000602082840312156104a6576104a56103a0565b5b60006104b48482850161047b565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006104f7826103a5565b9150610502836103a5565b925082820190508082111561051a576105196104bd565b5b92915050565b600081519050919050565b6000819050602082019050919050565b60007fffffffffffffffffffffffffffffffffffffffff00000000000000000000000082169050919050565b6000610573825161053b565b80915050919050565b600082821b905092915050565b600061059482610520565b8261059e8461052b565b90506105a981610567565b925060148210156105e9576105e47fffffffffffffffffffffffffffffffffffffffff0000000000000000000000008360140360080261057c565b831692505b5050919050565b6000819050919050565b6000819050919050565b600061061f61061a610615846105f0565b6105fa565b6103a5565b9050919050565b61062f81610604565b82525050565b6000819050919050565b600060ff82169050919050565b600061066761066261065d84610635565b6105fa565b61063f565b9050919050565b6106778161064c565b82525050565b60006040820190506106926000830185610626565b61069f602083018461066e565b9392505050565b6000819050919050565b60006106cb6106c66106c1846106a6565b6105fa565b61063f565b9050919050565b6106db816106b0565b82525050565b6000819050919050565b600061ffff82169050919050565b600061071461070f61070a846106e1565b6105fa565b6106eb565b9050919050565b610724816106f9565b82525050565b6000819050919050565b600063ffffffff82169050919050565b600061075f61075a6107558461072a565b6105fa565b610734565b9050919050565b61076f81610744565b82525050565b6000819050919050565b600067ffffffffffffffff82169050919050565b60006107ae6107a96107a484610775565b6105fa565b61077f565b9050919050565b6107be81610793565b82525050565b6000819050919050565b60006fffffffffffffffffffffffffffffffff82169050919050565b60006108056108006107fb846107c4565b6105fa565b6107ce565b9050919050565b610815816107ea565b82525050565b6000819050919050565b600061084061083b6108368461081b565b6105fa565b6103a5565b9050919050565b61085081610825565b82525050565b600060c08201905061086b60008301896106d2565b610878602083018861071b565b6108856040830187610766565b61089260608301866107b5565b61089f608083018561080c565b6108ac60a0830184610847565b97965050505050505056fe307838323231313933344333343062323935363133383133393233343844343834313345313541444338a2646970667358221220602cb20f9fda43c380fec5435cb9da37e1a0caa5a27847fb7a31f6660f663c3564736f6c63430008130033\",\"output\":\"0x608060405234801561001057600080fd5b50600436106100a95760003560e01c806383f9a7d51161007157806383f9a7d514610140578063873d1a021461015c5780638a063ff61461017a578063d09de08a14610184578063dcd9c7fa1461018e578063f315cde1146101aa576100a9565b8063067d5cd5146100ae57806312065fe0146100de5780632e64cec1146100fc5780634bb278f31461011a5780636057361d14610124575b600080fd5b6100c860048036038101906100c391906103db565b6101da565b6040516100d59190610417565b60405180910390f35b6100e66101fe565b6040516100f39190610417565b60405180910390f35b610104610208565b6040516101119190610417565b60405180910390f35b610122610211565b005b61013e600480360381019061013991906103db565b610253565b005b61015a60048036038101906101559190610490565b61025d565b005b61016461028a565b6040516101719190610417565b60405180910390f35b6101826102ad565b005b61018c610332565b005b6101a860048036038101906101a391906103db565b61034d565b005b6101c460048036038101906101bf91906103db565b610387565b6040516101d19190610417565b60405180910390f35b6000816000808282546101ed91906104ec565b925050819055506000549050919050565b6000600154905090565b60008054905090565b60006040518060600160405280602a81526020016108b8602a913961023590610589565b60601c90508073ffffffffffffffffffffffffffffffffffffffff16ff5b8060008190555050565b60018173ffffffffffffffffffffffffffffffffffffffff163161028191906104ec565b60018190555050565b6000600160008082825461029e91906104ec565b92505081905550600054905090565b7f8604f2dc82d77e997bcc9f6b4a10c9175a9be5fb69a9ef44bbb5c4eaa66ca36461148460c86040516102e192919061067d565b60405180910390a17f99986dab9136c96a7db07b9393684e3a152ce628162b6ebbdb6fbdca3ae2d581600a6014601e60286032603c60405161032896959493929190610856565b60405180910390a1565b600160008082825461034491906104ec565b92505081905550565b7f2adf2e2e5f5d116e0d0e1f0231d3f5b75916c3d37d9a16ce060f634cbcc614308160405161037c9190610417565b60405180910390a150565b600060018261039691906104ec565b9150819050919050565b600080fd5b6000819050919050565b6103b8816103a5565b81146103c357600080fd5b50565b6000813590506103d5816103af565b92915050565b6000602082840312156103f1576103f06103a0565b5b60006103ff848285016103c6565b91505092915050565b610411816103a5565b82525050565b600060208201905061042c6000830184610408565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061045d82610432565b9050919050565b61046d81610452565b811461047857600080fd5b50565b60008135905061048a81610464565b92915050565b6000602082840312156104a6576104a56103a0565b5b60006104b48482850161047b565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006104f7826103a5565b9150610502836103a5565b925082820190508082111561051a576105196104bd565b5b92915050565b600081519050919050565b6000819050602082019050919050565b60007fffffffffffffffffffffffffffffffffffffffff00000000000000000000000082169050919050565b6000610573825161053b565b80915050919050565b600082821b905092915050565b600061059482610520565b8261059e8461052b565b90506105a981610567565b925060148210156105e9576105e47fffffffffffffffffffffffffffffffffffffffff0000000000000000000000008360140360080261057c565b831692505b5050919050565b6000819050919050565b6000819050919050565b600061061f61061a610615846105f0565b6105fa565b6103a5565b9050919050565b61062f81610604565b82525050565b6000819050919050565b600060ff82169050919050565b600061066761066261065d84610635565b6105fa565b61063f565b9050919050565b6106778161064c565b82525050565b60006040820190506106926000830185610626565b61069f602083018461066e565b9392505050565b6000819050919050565b60006106cb6106c66106c1846106a6565b6105fa565b61063f565b9050919050565b6106db816106b0565b82525050565b6000819050919050565b600061ffff82169050919050565b600061071461070f61070a846106e1565b6105fa565b6106eb565b9050919050565b610724816106f9565b82525050565b6000819050919050565b600063ffffffff82169050919050565b600061075f61075a6107558461072a565b6105fa565b610734565b9050919050565b61076f81610744565b82525050565b6000819050919050565b600067ffffffffffffffff82169050919050565b60006107ae6107a96107a484610775565b6105fa565b61077f565b9050919050565b6107be81610793565b82525050565b6000819050919050565b60006fffffffffffffffffffffffffffffffff82169050919050565b60006108056108006107fb846107c4565b6105fa565b6107ce565b9050919050565b610815816107ea565b82525050565b6000819050919050565b600061084061083b6108368461081b565b6105fa565b6103a5565b9050919050565b61085081610825565b82525050565b600060c08201905061086b60008301896106d2565b610878602083018861071b565b6108856040830187610766565b61089260608301866107b5565b61089f608083018561080c565b6108ac60a0830184610847565b97965050505050505056fe307838323231313933344333343062323935363133383133393233343844343834313345313541444338a2646970667358221220602cb20f9fda43c380fec5435cb9da37e1a0caa5a27847fb7a31f6660f663c3564736f6c63430008130033\",\"value\":\"0x0\",\"type\":\"CREATE\"}",
    )
    .await;
}
